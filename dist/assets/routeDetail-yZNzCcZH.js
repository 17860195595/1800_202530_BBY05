import"./modulepreload-polyfill-B5Qt9EMX.js";import"./components-9bzrBSqj.js";import{a as I,d as m,c as N,g as P}from"./firebaseConfig-D6gRsOSx.js";import{o as O}from"./vendor-DQ-sQAqT.js";import{i as F,b as z,r as $,a as U}from"./favoritesService-ifpvRFdY.js";import{f as j}from"./trafficService-DxV7s4Yh.js";import{s as p,a as H,b as _}from"./notifications-DXz7xSIH.js";async function J(e,t,o){const n=`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${e}`,i={coordinates:[[t[1],t[0]],[o[1],o[0]]],preference:"fastest",alternative_routes:{target_count:3,share_factor:.6,weight_factor:2}},r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","User-Agent":"ClearWay/1.0"},body:JSON.stringify(i)});if(!r.ok){const c=await r.text();throw new Error(`ORS failed ${r.status}: ${c}`)}const a=await r.json();return!a.routes||a.routes.length===0?null:V(a.routes)}function V(e){const t=e[0];return{primary:{coordinates:T(t.geometry),distanceKm:t.summary.distance/1e3,durationSec:t.summary.duration},alternatives:e.slice(1).map(o=>({coordinates:T(o.geometry)}))}}function T(e){if(!e)return[];const t=[],o=1e5;let n=0,i=0,r=0;for(;n<e.length;){let a=0,c=0,l=0;do a=e.charCodeAt(n++)-63,l|=(a&31)<<c,c+=5;while(a>=32);const v=l&1?~(l>>1):l>>1;i+=v,l=0,c=0;do a=e.charCodeAt(n++)-63,l|=(a&31)<<c,c+=5;while(a>=32);const w=l&1?~(l>>1):l>>1;r+=w,t.push([i/o,r/o])}return t}let s=null,b=null,g=null,d=null,h=null,u=null,M=[];document.addEventListener("DOMContentLoaded",function(){Y(),G(),ne(),Ie(),O(I,e=>{E()}),ue()});function Y(){if(typeof L>"u"){console.error("Leaflet map library not loaded");return}s=L.map("map").setView([49.2427,-123.0007],12),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(s)}function y(e){e&&s&&s.hasLayer(e)&&s.removeLayer(e)}function R(){s&&(M.forEach(e=>{s.hasLayer(e)&&s.removeLayer(e)}),M=[])}function G(){let e=sessionStorage.getItem("routeDetail");if(e||(e=localStorage.getItem("lastRouteDetail")),e)try{const t=JSON.parse(e);u=t,K(t),localStorage.setItem("lastRouteDetail",JSON.stringify(t)),E()}catch(t){console.warn("Failed to parse routeDetail:",t)}else console.log("No routeDetail found in session/local storage"),p("No route data found. Please open from Search or Favorites")}function K(e){s&&(y(d),y(h),R(),d=L.marker([e.lat,e.lng]).addTo(s),d.bindPopup(`
    <b>${e.name}</b><br>
    ${e.address}
  `),Z(e),g?k(g,[e.lat,e.lng]):s.setView([e.lat,e.lng],15),console.log("Display route detail:",e))}function Z(e){const t=document.getElementById("userLocation");t&&(e.name?t.value=e.name.length>40?e.name.substring(0,37)+"...":e.name:e.address?t.value=e.address.length>40?e.address.substring(0,37)+"...":e.address:t.value="Destination")}function k(e,t){s&&(y(h),R(),q(e,t))}async function q(e,t){try{const n=await J("eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjhjMzA4ODEzNTEyNjQ0YmJhOGY3MTQ4NTk2MzJlYWY1IiwiaCI6Im11cm11cjY0In0=",e,t);if(n&&n.primary){const i=n.primary.coordinates;h=L.polyline(i,{color:"#007bff",weight:4,opacity:.7}).addTo(s),n.alternatives&&n.alternatives.length>0&&W(n.alternatives.map(c=>({geometry:null,coords:c.coordinates}))),s.fitBounds(h.getBounds(),{padding:[50,50]});const r=n.primary.distanceKm,a=n.primary.durationSec;X(r,a),m?S(e,t):console.warn("Firebase Firestore not available, skipping traffic reports"),console.log("Route fetched successfully:",{distance:r,duration:a})}else console.warn("No routes found in API response"),p("No route from service. Using straight line"),x(e,t)}catch(o){console.error("Failed to fetch route from API, using straight line:",o),console.error("Error details:",o.message),p("Route service unavailable. Using straight line"),x(e,t)}}function x(e,t){console.log("Using fallback straight line route"),h=L.polyline([e,t],{color:"#007bff",weight:4,opacity:.7,dashArray:"10, 5"}).addTo(s);const o=[[e[0],e[1]],[t[0],t[1]]];s.fitBounds(o,{padding:[50,50]}),ee(e,t),m?S(e,t):console.warn("Firebase Firestore not available, skipping traffic reports")}function W(e){try{e.forEach(t=>{let o=null;t.coords&&Array.isArray(t.coords)?o=t.coords:t.geometry&&(o=Q(t.geometry)),!(!o||o.length===0)&&L.polyline(o,{color:"#6c757d",weight:3,opacity:.5,dashArray:"6,6"}).addTo(s)})}catch(t){console.warn("Failed to draw alternative routes:",t)}}function Q(e){if(!e)return[];const t=[],o=1e5;let n=0,i=0,r=0;for(;n<e.length;){let a=0,c=0,l=0;do a=e.charCodeAt(n++)-63,l|=(a&31)<<c,c+=5;while(a>=32);const v=l&1?~(l>>1):l>>1;i+=v,l=0,c=0;do a=e.charCodeAt(n++)-63,l|=(a&31)<<c,c+=5;while(a>=32);const w=l&1?~(l>>1):l>>1;r+=w,t.push([i/o,r/o])}return t}function X(e,t){const o=document.getElementById("routeDistance"),n=document.getElementById("routeDuration");o&&(o.textContent=B(e)),n&&(n.textContent=te(t))}function ee(e,t){const o=oe(e[0],e[1],t[0],t[1]),i=Math.round(o/50*60),r=document.getElementById("routeDistance"),a=document.getElementById("routeDuration");r&&(r.textContent=B(o)),a&&(a.textContent=C(i))}function B(e){return e>=1?`${e.toFixed(1)}km`:`${Math.round(e*1e3)}m`}function te(e){const t=Math.round(e/60);return C(t)}function C(e){if(e>=60){const t=Math.floor(e/60),o=e%60;return`${t}h ${o}min`}else return`${e}min`}function oe(e,t,o,n){const r=(o-e)*Math.PI/180,a=(n-t)*Math.PI/180,c=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(a/2)*Math.sin(a/2);return 6371*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function ne(){if(!navigator.geolocation){D();return}navigator.geolocation.getCurrentPosition(e=>A(e),e=>{console.log("Unable to get user location. Showing default:",e),D()},{enableHighAccuracy:!1,timeout:3e3,maximumAge:3e5})}function ae(){if(!navigator.geolocation){alert("Geolocation is not supported by your browser");return}const e=document.getElementById("getLocation");e&&(e.disabled=!0,e.style.opacity="0.6"),navigator.geolocation.getCurrentPosition(t=>{A(t);const o=t.coords.latitude,n=t.coords.longitude;ce(o,n),d&&k(g,[d.getLatLng().lat,d.getLatLng().lng]),e&&(e.disabled=!1,e.style.opacity="1")},t=>{console.error("Failed to get location:",t);const o=se(t);alert(o),e&&(e.disabled=!1,e.style.opacity="1")},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})}function A(e){const t=e.coords.latitude,o=e.coords.longitude,n=e.coords.accuracy;y(b),b=ie(t,o),L.circle([t,o],{radius:n,color:"#007bff",fillColor:"#007bff",fillOpacity:.1,weight:2}).addTo(s),g=[t,o],re(t,o),b.bindPopup(`
        <b>My location</b><br>
        Lat: ${t.toFixed(6)}<br>
        Lng: ${o.toFixed(6)}<br>
        Accuracy: Â±${Math.round(n)}m
      `).openPopup(),d&&k(g,[d.getLatLng().lat,d.getLatLng().lng]),console.log("User location obtained")}function ie(e,t){return L.marker([e,t],{icon:L.divIcon({className:"user-location-marker",html:'<div class="user-location-pulse"></div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo(s)}function re(e,t){if(d){const o=[[e,t],[d.getLatLng().lat,d.getLatLng().lng]];s.fitBounds(o,{padding:[50,50]})}else s.setView([e,t],15)}function se(e){let t="Failed to get location: ";switch(e.code){case e.PERMISSION_DENIED:t+="Permission denied";break;case e.POSITION_UNAVAILABLE:t+="Position unavailable";break;case e.TIMEOUT:t+="Request timed out";break;default:t+="Unknown error";break}return t}function D(){L.marker([49.2827,-123.1207]).addTo(s).bindPopup("<b>Vancouver</b><br>Default location").openPopup(),s.setView([49.2827,-123.1207],12),console.log("Show default location")}function ce(e,t){const o=document.getElementById("userLocation");if(!o)return;const n=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",i=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}&addressdetails=1`;let r;n?r=`/api/nominatim/reverse?format=json&lat=${e}&lon=${t}&addressdetails=1`:r=`https://api.allorigins.win/raw?url=${encodeURIComponent(i)}`,fetch(r,{headers:{Accept:"application/json"}}).then(a=>a.json()).then(a=>{a&&a.display_name?o.value=a.display_name.split(",")[0]||"Current Location":o.value="Current Location"}).catch(a=>{console.error("Reverse geocoding failed:",a),o.value="Current Location"})}async function S(e,t){try{if(console.log("Attempting to fetch traffic reports from Firestore..."),!m){console.error("Firebase Firestore not initialized");return}const o=le(e,t),n=await j(m,o,2);de(n),console.log("Traffic reports fetched from Firestore:",n.length)}catch(o){console.error("Failed to fetch traffic reports from Firestore:",o),console.error("Error details:",o.message),console.error("Error code:",o.code),o.code==="permission-denied"?console.warn("Firestore permission denied. Please check your security rules."):o.code==="unavailable"&&console.warn("Firestore service unavailable. Please check your internet connection.")}}function le(e,t){const o=e[0],n=e[1],i=t[0],r=t[1],a=.1,c={minLat:Math.min(o,i)-a,maxLat:Math.max(o,i)+a,minLng:Math.min(n,r)-a,maxLng:Math.max(n,r)+a};return console.log("Route bounds:",c),console.log("Start:",e,"End:",t),c}async function ue(){try{if(console.log("Testing Firebase Firestore connection..."),console.log("Firestore instance:",m),!m){console.error("Firebase Firestore not initialized");return}const e=N(m,"trafficReports");console.log("Test collection ref created:",e);const t=await P(e);console.log("Test snapshot:",t),t.empty?console.log("Firebase Firestore connection test successful - no data in collection (this is normal)"):(console.log("Firebase Firestore connection test successful - data found"),console.log("Number of documents:",t.size))}catch(e){console.error("Firebase Firestore connection test failed:",e),console.error("Error details:",e.message),console.error("Error code:",e.code),e.code==="permission-denied"?(console.warn("Permission denied. Please check your Firestore security rules."),console.warn("Temporary solution: Go to Firebase Console > Firestore > Rules and set:"),console.warn('rules_version = "2";'),console.warn("service cloud.firestore {"),console.warn("  match /databases/{database}/documents {"),console.warn("    match /{document=**} {"),console.warn("      allow read, write: if true;"),console.warn("    }"),console.warn("  }"),console.warn("}")):e.code==="unavailable"&&console.warn("Firestore service unavailable. Please check your internet connection and Firebase project status.")}}function de(e){!e||!Array.isArray(e)||e.length===0||e.forEach(t=>{let o=null;if(Array.isArray(t.position)?o=t.position:t.position&&typeof t.position=="object"?o=[t.position.lat,t.position.lng]:t.lat!==void 0&&t.lng!==void 0&&(o=[t.lat,t.lng]),!o||o.length<2){console.warn("Invalid report position:",t);return}const n={username:t.username,type:t.type,comment:t.comment,createdAt:t.createdAt||t.created_at||t.timestamp};fe(o,{tooltip:"ç‚¹å‡»æŸ¥çœ‹äº¤é€šçŠ¶å†µ",report:n})})}function fe(e,t={}){if(!s)return console.error("Map not initialized"),null;if(!e||e.length<2)return console.error("Invalid position:",e),null;const o={tooltip:"View traffic",onClick:null,iconSize:[40,40],...t},n=me(o);try{const i=L.marker([e[0],e[1]],{icon:n,zIndexOffset:1e3,riseOnHover:!0}).addTo(s);return ge(i,e,o),M.push(i),i}catch(i){return console.error("Error adding traffic marker:",i),null}}function me(e){const t=`
    <div style="
      width: ${e.iconSize[0]}px;
      height: ${e.iconSize[1]}px;
      background-color: #ff4444;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      font-weight: bold;
      transition: transform 0.2s ease;
    ">ðŸš¦</div>
  `;return L.divIcon({className:"traffic-icon-marker",html:t,iconSize:e.iconSize,iconAnchor:[e.iconSize[0]/2,e.iconSize[1]/2]})}function ge(e,t,o){e.on("click",n=>{console.log("Traffic marker clicked"),n.originalEvent.stopPropagation(),o.onClick?o.onClick(n,e,t):(Me(),o.report&&he(o.report))}),o.tooltip&&e.bindTooltip(o.tooltip,{permanent:!1,direction:"top",offset:[0,-15],className:"traffic-tooltip",opacity:.9}),e.on("mouseover",function(){this.setZIndexOffset(1500)}),e.on("mouseout",function(){this.setZIndexOffset(1e3)})}function he(e){const t=document.getElementById("trafficReporterName"),o=document.getElementById("trafficReportType"),n=document.getElementById("trafficReportComment"),i=document.getElementById("trafficReportTime");t&&(t.textContent=(e==null?void 0:e.username)||"-"),o&&(o.textContent=pe(e==null?void 0:e.type)),n&&(n.textContent=(e==null?void 0:e.comment)||"-"),i&&(i.textContent=ve(e==null?void 0:e.createdAt)||"â€”")}function pe(e){const t={accident:"Accident",construction:"Construction"};if(!e)return"-";const o=String(e).toLowerCase();return t[o]||e}function ye(e){if(!e)return null;try{if(typeof e=="object"){if(typeof e.toDate=="function")return e.toDate().getTime();if(typeof e.seconds=="number")return e.seconds*1e3+Math.floor((e.nanoseconds||0)/1e6)}if(typeof e=="number")return e<1e12?e*1e3:e;const t=e instanceof Date?e.getTime():new Date(e).getTime();return Number.isNaN(t)?null:t}catch{return null}}function ve(e){if(!e)return"";const t=Date.now(),o=ye(e);if(Number.isNaN(o))return"";const n=Math.max(0,t-o),i=Math.floor(n/6e4);if(i<1)return"Just now";if(i<60)return`${i} min ago`;const r=Math.floor(i/60);return r<24?`${r} h ago`:`${Math.floor(r/24)} d ago`}function E(){var t;if(!u){setTimeout(E,100);return}if(!m){f(!1);return}const e=(t=I.currentUser)==null?void 0:t.uid;if(!e){f(!1);return}F(e,u.lat,u.lng).then(o=>{f(!!o)}).catch(o=>{console.warn("checkIfRouteIsSaved failed:",o),f(!1)})}async function we(){var r;if(!u){console.log("No route data to save"),alert("No route data available to save");return}if(!m){alert("Database not available."),H("Database unavailable");return}const e=(r=I.currentUser)==null?void 0:r.uid;if(!e){alert("You must be logged in to save favorites");return}const t=z(u.lat,u.lng);if(await F(e,u.lat,u.lng)){await $(e,u.lat,u.lng),f(!1,!0),setTimeout(()=>f(!1),1500),console.log("Route removed from favorites (Firestore)"),p("Removed from favorites");return}const n={...be(),key:t,savedAt:new Date},i=await U(e,n);console.log("Route saved to favorites (Firestore):",i.id,n),f(!0),setTimeout(()=>f(!0,!1,!0),1500),_("Added to favorites")}function be(){const e=document.getElementById("userLocation"),t=document.getElementById("routeDistance"),o=document.getElementById("routeDuration");return{id:Date.now(),from:e&&e.value||"Current Location",to:u.name,toAddress:u.address,toLat:u.lat,toLng:u.lng,distance:t?t.textContent:"Unknown",duration:o?o.textContent:"Unknown",savedAt:new Date().toISOString()}}function f(e,t=!1,o=!1){const n=document.getElementById("saveRoute");n&&(t?(n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Unsaved</span>',n.style.background="#dc3545"):o?(n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Saved!</span>',n.style.background="#28a745"):e?(n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Saved</span>',n.style.background="#28a745"):(n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Save</span>',n.style.background="#333"))}function Le(){navigator.share?navigator.share({title:"Route Detail",text:"Check out this route!",url:window.location.href}):navigator.clipboard.writeText(window.location.href).then(()=>{const e=document.getElementById("shareRoute"),t=e.innerHTML;e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"></path><path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path><path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path><path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3"></path><path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3"></path></svg><span>Copied!</span>',e.style.background="#28a745",setTimeout(()=>{e.innerHTML=t,e.style.background="#333"},2e3)}),console.log("Route shared")}function Me(){const e=document.getElementById("trafficDetailModal");e?e.classList.add("show"):console.error("Traffic detail modal not found")}function Ie(){ke(),Ee(),Te(),xe()}function ke(){const e=document.getElementById("getLocation");e&&e.addEventListener("click",()=>{console.log("Get location button clicked"),ae()})}function Ee(){const e=document.getElementById("saveRoute");e&&e.addEventListener("click",()=>{we()})}function Te(){const e=document.getElementById("shareRoute");e&&e.addEventListener("click",()=>{Le()})}function xe(){const e=document.getElementById("trafficDetailModal"),t=document.getElementById("trafficCloseBtn");t&&e&&t.addEventListener("click",()=>{e.classList.remove("show")}),e&&e.addEventListener("click",o=>{o.target===e&&e.classList.remove("show")})}

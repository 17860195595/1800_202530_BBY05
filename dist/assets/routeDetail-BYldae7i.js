import"./modulepreload-polyfill-B5Qt9EMX.js";import"./components-ZI4bmTv0.js";let a=null,g=null,p=null,c=null,m=null,u=null;document.addEventListener("DOMContentLoaded",function(){C(),I(),T(),S(),b()});function I(){const t=sessionStorage.getItem("routeDetail");if(t){const o=JSON.parse(t);u=o,w(o),sessionStorage.removeItem("routeDetail")}}function w(t){a&&(c&&a.removeLayer(c),m&&a.removeLayer(m),c=L.marker([t.lat,t.lng]).addTo(a),c.bindPopup(`
    <b>${t.name}</b><br>
    ${t.address}
  `),p?v(p,[t.lat,t.lng]):a.setView([t.lat,t.lng],15),console.log("显示路由详情:",t))}function v(t,o){a&&(m&&a.removeLayer(m),k(t,o))}async function k(t,o){try{const e="https://api.openrouteservice.org/v2/directions/foot-walking",n={coordinates:[[t[1],t[0]],[o[1],o[0]]]},i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(n)});if(!i.ok)throw new Error("Route API request failed");const s=await i.json();if(s.routes&&s.routes.length>0){const r=s.routes[0],l=r.geometry,d=x(l);m=L.polyline(d,{color:"#007bff",weight:4,opacity:.7}).addTo(a),a.fitBounds(m.getBounds(),{padding:[50,50]});const f=r.summary.distance/1e3,h=r.summary.duration;B(f,h),console.log("Route fetched successfully:",{distance:f,duration:h})}}catch(e){console.error("Failed to fetch route from API, using straight line:",e),m=L.polyline([t,o],{color:"#007bff",weight:4,opacity:.7,dashArray:"10, 5"}).addTo(a);const n=[[t[0],t[1]],[o[0],o[1]]];a.fitBounds(n,{padding:[50,50]}),E(t,o)}}function x(t){if(!t)return[];const o=[],e=1e5;let n=0,i=0,s=0;for(;n<t.length;){let r=0,l=0,d=0;do r=t.charCodeAt(n++)-63,d|=(r&31)<<l,l+=5;while(r>=32);const f=d&1?~(d>>1):d>>1;i+=f,d=0,l=0;do r=t.charCodeAt(n++)-63,d|=(r&31)<<l,l+=5;while(r>=32);const h=d&1?~(d>>1):d>>1;s+=h,o.push([i/e,s/e])}return o}function B(t,o){const e=document.getElementById("routeDistance"),n=document.getElementById("routeDuration");if(e&&(t>=1?e.textContent=`${t.toFixed(1)}km`:e.textContent=`${Math.round(t*1e3)}m`),n){const i=Math.round(o/60);if(i>=60){const s=Math.floor(i/60),r=i%60;n.textContent=`${s}h ${r}min`}else n.textContent=`${i}min`}}function E(t,o){const e=R(t[0],t[1],o[0],o[1]),n=Math.round(e/5*60),i=document.getElementById("routeDistance"),s=document.getElementById("routeDuration");if(i&&(e>=1?i.textContent=`${e.toFixed(1)}km`:i.textContent=`${Math.round(e*1e3)}m`),s)if(n>=60){const r=Math.floor(n/60),l=n%60;s.textContent=`${r}h ${l}min`}else s.textContent=`${n}min`}function R(t,o,e,n){const s=(e-t)*Math.PI/180,r=(n-o)*Math.PI/180,l=Math.sin(s/2)*Math.sin(s/2)+Math.cos(t*Math.PI/180)*Math.cos(e*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function C(){if(typeof L>"u"){console.error("Leaflet map library not loaded");return}a=L.map("map").setView([49.2827,-123.1207],12),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(a)}function T(){if(!navigator.geolocation){M();return}navigator.geolocation.getCurrentPosition(t=>{const o=t.coords.latitude,e=t.coords.longitude;g&&a.removeLayer(g),g=L.marker([o,e],{icon:L.divIcon({className:"user-location-marker",html:'<div class="user-location-pulse"></div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo(a);const n=t.coords.accuracy;if(L.circle([o,e],{radius:n,color:"#007bff",fillColor:"#007bff",fillOpacity:.1,weight:2}).addTo(a),p=[o,e],c){const i=[[o,e],[c.getLatLng().lat,c.getLatLng().lng]];a.fitBounds(i,{padding:[50,50]})}else a.setView([o,e],15);g.bindPopup(`
        <b>我的位置</b><br>
        纬度: ${o.toFixed(6)}<br>
        经度: ${e.toFixed(6)}<br>
        精度: ±${Math.round(n)}米
      `).openPopup(),c&&v(p,[c.getLatLng().lat,c.getLatLng().lng]),console.log("成功获取用户位置")},t=>{console.log("无法获取用户位置，显示默认位置:",t),M()},{enableHighAccuracy:!1,timeout:3e3,maximumAge:3e5})}function M(){L.marker([49.2827,-123.1207]).addTo(a).bindPopup("<b>Vancouver</b><br>默认位置").openPopup(),a.setView([49.2827,-123.1207],12),console.log("显示默认位置")}function S(){const t=document.getElementById("getLocation");t&&t.addEventListener("click",()=>{console.log("获取位置按钮被点击"),D()});const o=document.getElementById("saveRoute");o&&o.addEventListener("click",()=>{P()});const e=document.getElementById("shareRoute");e&&e.addEventListener("click",()=>{$()})}function b(){if(!u){setTimeout(b,100);return}if(JSON.parse(localStorage.getItem("favoriteRoutes")||"[]").some(e=>Math.abs(e.toLat-u.lat)<.001&&Math.abs(e.toLng-u.lng)<.001)){const e=document.getElementById("saveRoute");e&&(e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Saved</span>',e.style.background="#28a745")}}function P(){if(!u){console.log("No route data to save"),alert("No route data available to save");return}const t=JSON.parse(localStorage.getItem("favoriteRoutes")||"[]"),o=t.findIndex(y=>Math.abs(y.toLat-u.lat)<.001&&Math.abs(y.toLng-u.lng)<.001),e=document.getElementById("saveRoute");if(o!==-1){t.splice(o,1),localStorage.setItem("favoriteRoutes",JSON.stringify(t)),e.innerHTML,e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Unsaved</span>',e.style.background="#dc3545",setTimeout(()=>{e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Save</span>',e.style.background="#333"},2e3),console.log("Route removed from favorites");return}const n=document.getElementById("userLocation"),i=document.getElementById("routeDistance"),s=document.getElementById("routeDuration"),r=n&&n.value||"Current Location",l=u.name,d=i?i.textContent:"Unknown",f=s?s.textContent:"Unknown",h={id:Date.now(),from:r,to:l,toAddress:u.address,toLat:u.lat,toLng:u.lng,distance:d,duration:f,savedAt:new Date().toISOString()};t.push(h),localStorage.setItem("favoriteRoutes",JSON.stringify(t)),e.innerHTML,e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Saved!</span>',e.style.background="#28a745",setTimeout(()=>{e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Saved</span>',e.style.background="#28a745"},2e3),console.log("Route saved to favorites:",h)}function $(){navigator.share?navigator.share({title:"Route Detail",text:"Check out this route!",url:window.location.href}):navigator.clipboard.writeText(window.location.href).then(()=>{const t=document.getElementById("shareRoute"),o=t.innerHTML;t.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"></path><path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path><path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path><path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3"></path><path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3"></path></svg><span>Copied!</span>',t.style.background="#28a745",setTimeout(()=>{t.innerHTML=o,t.style.background="#333"},2e3)}),console.log("Route shared")}function A(t,o){const e=document.getElementById("userLocation");e&&fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${o}&addressdetails=1`).then(n=>n.json()).then(n=>{n.display_name?e.value=n.display_name.split(",")[0]||"Current Location":e.value="Current Location"}).catch(n=>{console.error("Reverse geocoding failed:",n),e.value="Current Location"})}function D(){if(!navigator.geolocation){alert("您的浏览器不支持地理位置功能");return}const t=document.getElementById("getLocation");t&&(t.disabled=!0,t.style.opacity="0.6"),navigator.geolocation.getCurrentPosition(o=>{const e=o.coords.latitude,n=o.coords.longitude;g&&a.removeLayer(g),g=L.marker([e,n],{icon:L.divIcon({className:"user-location-marker",html:'<div class="user-location-pulse"></div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo(a);const i=o.coords.accuracy;if(L.circle([e,n],{radius:i,color:"#007bff",fillColor:"#007bff",fillOpacity:.1,weight:2}).addTo(a),p=[e,n],c){const s=[[e,n],[c.getLatLng().lat,c.getLatLng().lng]];a.fitBounds(s,{padding:[50,50]})}else a.setView([e,n],15);g.bindPopup(`
        <b>我的位置</b><br>
        纬度: ${e.toFixed(6)}<br>
        经度: ${n.toFixed(6)}<br>
        精度: ±${Math.round(i)}米
      `).openPopup(),A(e,n),c&&v(p,[c.getLatLng().lat,c.getLatLng().lng]),t&&(t.disabled=!1,t.style.opacity="1")},o=>{console.error("获取位置失败:",o);let e="获取位置失败: ";switch(o.code){case o.PERMISSION_DENIED:e+="用户拒绝了位置请求";break;case o.POSITION_UNAVAILABLE:e+="位置信息不可用";break;case o.TIMEOUT:e+="获取位置超时";break;default:e+="未知错误";break}alert(e),t&&(t.disabled=!1,t.style.opacity="1")},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})}

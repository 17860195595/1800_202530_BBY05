import"./modulepreload-polyfill-B5Qt9EMX.js";import"./components-9bzrBSqj.js";import{a as v,d as m,c as P,g as O}from"./firebaseConfig-D6gRsOSx.js";import{o as z}from"./vendor-DQ-sQAqT.js";import{i as R,b as U,r as $,a as j}from"./favoritesService-ifpvRFdY.js";import{f as H}from"./trafficService-DxV7s4Yh.js";import{s as p,a as _,b as J}from"./notifications-DXz7xSIH.js";async function V(e,t,o){const n=`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${e}`,r={coordinates:[[t[1],t[0]],[o[1],o[0]]],preference:"fastest",alternative_routes:{target_count:3,share_factor:.6,weight_factor:2}},a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","User-Agent":"ClearWay/1.0"},body:JSON.stringify(r)});if(!a.ok){const c=await a.text();throw new Error(`ORS failed ${a.status}: ${c}`)}const i=await a.json();return!i.routes||i.routes.length===0?null:Y(i.routes)}function Y(e){const t=e[0];return{primary:{coordinates:T(t.geometry),distanceKm:t.summary.distance/1e3,durationSec:t.summary.duration},alternatives:e.slice(1).map(o=>({coordinates:T(o.geometry)}))}}function T(e){if(!e)return[];const t=[],o=1e5;let n=0,r=0,a=0;for(;n<e.length;){let i=0,c=0,l=0;do i=e.charCodeAt(n++)-63,l|=(i&31)<<c,c+=5;while(i>=32);const w=l&1?~(l>>1):l>>1;r+=w,l=0,c=0;do i=e.charCodeAt(n++)-63,l|=(i&31)<<c,c+=5;while(i>=32);const b=l&1?~(l>>1):l>>1;a+=b,t.push([r/o,a/o])}return t}let s=null,M=null,g=null,d=null,h=null,u=null,I=[],F=!1;document.addEventListener("DOMContentLoaded",function(){G(),K(),ae(),ke(),z(v,e=>{F=!0,E()}),de()});function G(){if(typeof L>"u"){console.error("Leaflet map library not loaded");return}s=L.map("map").setView([49.2427,-123.0007],12),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(s)}function y(e){e&&s&&s.hasLayer(e)&&s.removeLayer(e)}function B(){s&&(I.forEach(e=>{s.hasLayer(e)&&s.removeLayer(e)}),I=[])}function K(){let e=sessionStorage.getItem("routeDetail");if(e||(e=localStorage.getItem("lastRouteDetail")),e)try{const t=JSON.parse(e);u=t,Z(t),localStorage.setItem("lastRouteDetail",JSON.stringify(t)),(F||v.currentUser)&&E()}catch(t){console.warn("Failed to parse routeDetail:",t)}else console.log("No routeDetail found in session/local storage"),p("No route data found. Please open from Search or Favorites")}function Z(e){s&&(y(d),y(h),B(),d=L.marker([e.lat,e.lng]).addTo(s),d.bindPopup(`
    <b>${e.name}</b><br>
    ${e.address}
  `),q(e),g?k(g,[e.lat,e.lng]):s.setView([e.lat,e.lng],15),console.log("Display route detail:",e))}function q(e){const t=document.getElementById("userLocation");t&&(e.name?t.value=e.name.length>40?e.name.substring(0,37)+"...":e.name:e.address?t.value=e.address.length>40?e.address.substring(0,37)+"...":e.address:t.value="Destination")}function k(e,t){s&&(y(h),B(),W(e,t))}async function W(e,t){try{const n=await V("eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjhjMzA4ODEzNTEyNjQ0YmJhOGY3MTQ4NTk2MzJlYWY1IiwiaCI6Im11cm11cjY0In0=",e,t);if(n&&n.primary){const r=n.primary.coordinates;h=L.polyline(r,{color:"#007bff",weight:4,opacity:.7}).addTo(s),n.alternatives&&n.alternatives.length>0&&Q(n.alternatives.map(c=>({geometry:null,coords:c.coordinates}))),s.fitBounds(h.getBounds(),{padding:[50,50]});const a=n.primary.distanceKm,i=n.primary.durationSec;ee(a,i),m?N(e,t):console.warn("Firebase Firestore not available, skipping traffic reports"),console.log("Route fetched successfully:",{distance:a,duration:i})}else console.warn("No routes found in API response"),p("No route from service. Using straight line"),x(e,t)}catch(o){console.error("Failed to fetch route from API, using straight line:",o),console.error("Error details:",o.message),p("Route service unavailable. Using straight line"),x(e,t)}}function x(e,t){console.log("Using fallback straight line route"),h=L.polyline([e,t],{color:"#007bff",weight:4,opacity:.7,dashArray:"10, 5"}).addTo(s);const o=[[e[0],e[1]],[t[0],t[1]]];s.fitBounds(o,{padding:[50,50]}),te(e,t),m?N(e,t):console.warn("Firebase Firestore not available, skipping traffic reports")}function Q(e){try{e.forEach(t=>{let o=null;t.coords&&Array.isArray(t.coords)?o=t.coords:t.geometry&&(o=X(t.geometry)),!(!o||o.length===0)&&L.polyline(o,{color:"#6c757d",weight:3,opacity:.5,dashArray:"6,6"}).addTo(s)})}catch(t){console.warn("Failed to draw alternative routes:",t)}}function X(e){if(!e)return[];const t=[],o=1e5;let n=0,r=0,a=0;for(;n<e.length;){let i=0,c=0,l=0;do i=e.charCodeAt(n++)-63,l|=(i&31)<<c,c+=5;while(i>=32);const w=l&1?~(l>>1):l>>1;r+=w,l=0,c=0;do i=e.charCodeAt(n++)-63,l|=(i&31)<<c,c+=5;while(i>=32);const b=l&1?~(l>>1):l>>1;a+=b,t.push([r/o,a/o])}return t}function ee(e,t){const o=document.getElementById("routeDistance"),n=document.getElementById("routeDuration");o&&(o.textContent=C(e)),n&&(n.textContent=oe(t))}function te(e,t){const o=ne(e[0],e[1],t[0],t[1]),r=Math.round(o/50*60),a=document.getElementById("routeDistance"),i=document.getElementById("routeDuration");a&&(a.textContent=C(o)),i&&(i.textContent=A(r))}function C(e){return e>=1?`${e.toFixed(1)}km`:`${Math.round(e*1e3)}m`}function oe(e){const t=Math.round(e/60);return A(t)}function A(e){if(e>=60){const t=Math.floor(e/60),o=e%60;return`${t}h ${o}min`}else return`${e}min`}function ne(e,t,o,n){const a=(o-e)*Math.PI/180,i=(n-t)*Math.PI/180,c=Math.sin(a/2)*Math.sin(a/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function ae(){if(!navigator.geolocation){D();return}navigator.geolocation.getCurrentPosition(e=>S(e),e=>{console.log("Unable to get user location. Showing default:",e),D()},{enableHighAccuracy:!1,timeout:3e3,maximumAge:3e5})}function re(){if(!navigator.geolocation){alert("Geolocation is not supported by your browser");return}const e=document.getElementById("getLocation");e&&(e.disabled=!0,e.style.opacity="0.6"),navigator.geolocation.getCurrentPosition(t=>{S(t);const o=t.coords.latitude,n=t.coords.longitude;le(o,n),d&&k(g,[d.getLatLng().lat,d.getLatLng().lng]),e&&(e.disabled=!1,e.style.opacity="1")},t=>{console.error("Failed to get location:",t);const o=ce(t);alert(o),e&&(e.disabled=!1,e.style.opacity="1")},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})}function S(e){const t=e.coords.latitude,o=e.coords.longitude,n=e.coords.accuracy;y(M),M=ie(t,o),L.circle([t,o],{radius:n,color:"#007bff",fillColor:"#007bff",fillOpacity:.1,weight:2}).addTo(s),g=[t,o],se(t,o),M.bindPopup(`
        <b>My location</b><br>
        Lat: ${t.toFixed(6)}<br>
        Lng: ${o.toFixed(6)}<br>
        Accuracy: Â±${Math.round(n)}m
      `).openPopup(),d&&k(g,[d.getLatLng().lat,d.getLatLng().lng]),console.log("User location obtained")}function ie(e,t){return L.marker([e,t],{icon:L.divIcon({className:"user-location-marker",html:'<div class="user-location-pulse"></div>',iconSize:[20,20],iconAnchor:[10,10]})}).addTo(s)}function se(e,t){if(d){const o=[[e,t],[d.getLatLng().lat,d.getLatLng().lng]];s.fitBounds(o,{padding:[50,50]})}else s.setView([e,t],15)}function ce(e){let t="Failed to get location: ";switch(e.code){case e.PERMISSION_DENIED:t+="Permission denied";break;case e.POSITION_UNAVAILABLE:t+="Position unavailable";break;case e.TIMEOUT:t+="Request timed out";break;default:t+="Unknown error";break}return t}function D(){L.marker([49.2827,-123.1207]).addTo(s).bindPopup("<b>Vancouver</b><br>Default location").openPopup(),s.setView([49.2827,-123.1207],12),console.log("Show default location")}function le(e,t){const o=document.getElementById("userLocation");if(!o)return;const n=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}&addressdetails=1`,r=`https://api.allorigins.win/get?url=${encodeURIComponent(n)}`;fetch(r,{headers:{Accept:"application/json"}}).then(a=>a.json()).then(a=>JSON.parse(a.contents)).then(a=>{a.display_name?o.value=a.display_name.split(",")[0]||"Current Location":o.value="Current Location"}).catch(a=>{console.error("Reverse geocoding failed:",a),o.value="Current Location"})}async function N(e,t){try{if(console.log("Attempting to fetch traffic reports from Firestore..."),!m){console.error("Firebase Firestore not initialized");return}const o=ue(e,t),n=await H(m,o,2);fe(n),console.log("Traffic reports fetched from Firestore:",n.length)}catch(o){console.error("Failed to fetch traffic reports from Firestore:",o),console.error("Error details:",o.message),console.error("Error code:",o.code),o.code==="permission-denied"?console.warn("Firestore permission denied. Please check your security rules."):o.code==="unavailable"&&console.warn("Firestore service unavailable. Please check your internet connection.")}}function ue(e,t){const o=e[0],n=e[1],r=t[0],a=t[1],i=.1,c={minLat:Math.min(o,r)-i,maxLat:Math.max(o,r)+i,minLng:Math.min(n,a)-i,maxLng:Math.max(n,a)+i};return console.log("Route bounds:",c),console.log("Start:",e,"End:",t),c}async function de(){try{if(console.log("Testing Firebase Firestore connection..."),console.log("Firestore instance:",m),!m){console.error("Firebase Firestore not initialized");return}const e=P(m,"trafficReports");console.log("Test collection ref created:",e);const t=await O(e);console.log("Test snapshot:",t),t.empty?console.log("Firebase Firestore connection test successful - no data in collection (this is normal)"):(console.log("Firebase Firestore connection test successful - data found"),console.log("Number of documents:",t.size))}catch(e){console.error("Firebase Firestore connection test failed:",e),console.error("Error details:",e.message),console.error("Error code:",e.code),e.code==="permission-denied"?(console.warn("Permission denied. Please check your Firestore security rules."),console.warn("Temporary solution: Go to Firebase Console > Firestore > Rules and set:"),console.warn('rules_version = "2";'),console.warn("service cloud.firestore {"),console.warn("  match /databases/{database}/documents {"),console.warn("    match /{document=**} {"),console.warn("      allow read, write: if true;"),console.warn("    }"),console.warn("  }"),console.warn("}")):e.code==="unavailable"&&console.warn("Firestore service unavailable. Please check your internet connection and Firebase project status.")}}function fe(e){!e||!Array.isArray(e)||e.length===0||e.forEach(t=>{let o=null;if(Array.isArray(t.position)?o=t.position:t.position&&typeof t.position=="object"?o=[t.position.lat,t.position.lng]:t.lat!==void 0&&t.lng!==void 0&&(o=[t.lat,t.lng]),!o||o.length<2){console.warn("Invalid report position:",t);return}const n={username:t.username,type:t.type,comment:t.comment,createdAt:t.createdAt||t.created_at||t.timestamp};me(o,{tooltip:"ç‚¹å‡»æŸ¥çœ‹äº¤é€šçŠ¶å†µ",report:n})})}function me(e,t={}){if(!s)return console.error("Map not initialized"),null;if(!e||e.length<2)return console.error("Invalid position:",e),null;const o={tooltip:"View traffic",onClick:null,iconSize:[40,40],...t},n=ge(o);try{const r=L.marker([e[0],e[1]],{icon:n,zIndexOffset:1e3,riseOnHover:!0}).addTo(s);return he(r,e,o),I.push(r),r}catch(r){return console.error("Error adding traffic marker:",r),null}}function ge(e){const t=`
    <div style="
      width: ${e.iconSize[0]}px;
      height: ${e.iconSize[1]}px;
      background-color: #ff4444;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      font-weight: bold;
      transition: transform 0.2s ease;
    ">ðŸš¦</div>
  `;return L.divIcon({className:"traffic-icon-marker",html:t,iconSize:e.iconSize,iconAnchor:[e.iconSize[0]/2,e.iconSize[1]/2]})}function he(e,t,o){e.on("click",n=>{console.log("Traffic marker clicked"),n.originalEvent.stopPropagation(),o.onClick?o.onClick(n,e,t):(Ie(),o.report&&pe(o.report))}),o.tooltip&&e.bindTooltip(o.tooltip,{permanent:!1,direction:"top",offset:[0,-15],className:"traffic-tooltip",opacity:.9}),e.on("mouseover",function(){this.setZIndexOffset(1500)}),e.on("mouseout",function(){this.setZIndexOffset(1e3)})}function pe(e){const t=document.getElementById("trafficReporterName"),o=document.getElementById("trafficReportType"),n=document.getElementById("trafficReportComment"),r=document.getElementById("trafficReportTime");t&&(t.textContent=(e==null?void 0:e.username)||"-"),o&&(o.textContent=ye(e==null?void 0:e.type)),n&&(n.textContent=(e==null?void 0:e.comment)||"-"),r&&(r.textContent=we(e==null?void 0:e.createdAt)||"â€”")}function ye(e){const t={accident:"Accident",construction:"Construction"};if(!e)return"-";const o=String(e).toLowerCase();return t[o]||e}function ve(e){if(!e)return null;try{if(typeof e=="object"){if(typeof e.toDate=="function")return e.toDate().getTime();if(typeof e.seconds=="number")return e.seconds*1e3+Math.floor((e.nanoseconds||0)/1e6)}if(typeof e=="number")return e<1e12?e*1e3:e;const t=e instanceof Date?e.getTime():new Date(e).getTime();return Number.isNaN(t)?null:t}catch{return null}}function we(e){if(!e)return"";const t=Date.now(),o=ve(e);if(Number.isNaN(o))return"";const n=Math.max(0,t-o),r=Math.floor(n/6e4);if(r<1)return"Just now";if(r<60)return`${r} min ago`;const a=Math.floor(r/60);return a<24?`${a} h ago`:`${Math.floor(a/24)} d ago`}function E(){var t;if(!u){setTimeout(E,100);return}if(!m){f(!1);return}const e=(t=v.currentUser)==null?void 0:t.uid;if(!e){f(!1);return}R(e,u.lat,u.lng).then(o=>{console.log("Route saved status:",o,"for route:",u.name),f(!!o)}).catch(o=>{console.warn("checkIfRouteIsSaved failed:",o),f(!1)})}async function be(){var a;if(!u){console.log("No route data to save"),alert("No route data available to save");return}if(!m){alert("Database not available."),_("Database unavailable");return}const e=(a=v.currentUser)==null?void 0:a.uid;if(!e){alert("You must be logged in to save favorites");return}const t=U(u.lat,u.lng);if(await R(e,u.lat,u.lng)){await $(e,u.lat,u.lng),f(!1,!0),setTimeout(()=>f(!1),1500),console.log("Route removed from favorites (Firestore)"),p("Removed from favorites");return}const n={...Le(),key:t,savedAt:new Date},r=await j(e,n);console.log("Route saved to favorites (Firestore):",r.id,n),f(!0),setTimeout(()=>f(!0,!1,!0),1500),J("Added to favorites")}function Le(){const e=document.getElementById("userLocation"),t=document.getElementById("routeDistance"),o=document.getElementById("routeDuration");return{id:Date.now(),from:e&&e.value||"Current Location",to:u.name,toAddress:u.address,toLat:u.lat,toLng:u.lng,distance:t?t.textContent:"Unknown",duration:o?o.textContent:"Unknown",savedAt:new Date().toISOString()}}function f(e,t=!1,o=!1){const n=document.getElementById("saveRoute");n&&(t?(n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Unsaved</span>',n.style.background="#dc3545"):o?(n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Saved!</span>',n.style.background="#28a745"):e?(n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Saved</span>',n.style.background="#28a745"):(n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Save</span>',n.style.background="#333"))}function Me(){navigator.share?navigator.share({title:"Route Detail",text:"Check out this route!",url:window.location.href}):navigator.clipboard.writeText(window.location.href).then(()=>{const e=document.getElementById("shareRoute"),t=e.innerHTML;e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"></path><path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path><path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path><path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3"></path><path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3"></path></svg><span>Copied!</span>',e.style.background="#28a745",setTimeout(()=>{e.innerHTML=t,e.style.background="#333"},2e3)}),console.log("Route shared")}function Ie(){const e=document.getElementById("trafficDetailModal");e?e.classList.add("show"):console.error("Traffic detail modal not found")}function ke(){Ee(),Te(),xe(),De()}function Ee(){const e=document.getElementById("getLocation");e&&e.addEventListener("click",()=>{console.log("Get location button clicked"),re()})}function Te(){const e=document.getElementById("saveRoute");e&&e.addEventListener("click",()=>{be()})}function xe(){const e=document.getElementById("shareRoute");e&&e.addEventListener("click",()=>{Me()})}function De(){const e=document.getElementById("trafficDetailModal"),t=document.getElementById("trafficCloseBtn");t&&e&&t.addEventListener("click",()=>{e.classList.remove("show")}),e&&e.addEventListener("click",o=>{o.target===e&&e.classList.remove("show")})}
